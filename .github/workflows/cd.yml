name: CD - Deploy to Render (desde CI)

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed

concurrency:
  group: cd-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Render deploy webhook
        env:
          RENDER_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_HOOK" ]; then
            echo "RENDER_DEPLOY_HOOK no está definido"; exit 1
          fi
          echo "Llamando al webhook de Render..."
          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$RENDER_HOOK" -H "Content-Type: application/json" -d '{}')
          echo "HTTP status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Webhook ejecutado correctamente"
          else
            echo "❌ Error al llamar al webhook (HTTP $HTTP_CODE)"; exit 1
          fi
