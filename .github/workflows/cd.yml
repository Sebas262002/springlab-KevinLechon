name: CD - Deploy to Render with Auto Rollback

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Forzar despliegue (incluso si no hay cambios)'
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/test/

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.deploy.outputs.success }}
      deploy_id: ${{ steps.deploy.outputs.deploy_id }}
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      - name: Update version in application.yml
        run: |
          echo "=== ACTUALIZANDO VERSION ==="
          echo "Build number: ${{ github.run_number }}"
          echo "Commit SHA: ${{ github.sha }}"
          
          # Crear la versi√≥n usando build number y commit hash corto
          VERSION="${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "Nueva versi√≥n: $VERSION"
          
          # Actualizar application.yml
          if grep -q "app:" src/main/resources/application.yml; then
            # Si ya existe la secci√≥n app, actualizar version
            sed -i "/^app:/,/^[[:alpha:]]/ s/version:.*/version: \"$VERSION\"/" src/main/resources/application.yml
          else
            # Si no existe, agregar la secci√≥n completa
            echo "" >> src/main/resources/application.yml
            echo "app:" >> src/main/resources/application.yml
            echo "  version: \"$VERSION\"" >> src/main/resources/application.yml
          fi
          
          echo "Contenido actualizado de application.yml:"
          cat src/main/resources/application.yml
          
          # Guardar la versi√≥n para otros jobs
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build application
        run: |
          echo "=== COMPILANDO APLICACION ==="
          ./gradlew clean build -x test
          echo "‚úÖ Compilaci√≥n exitosa"

      - name: Deploy to Render
        id: deploy
        run: |
          echo "=== DESPLEGANDO A RENDER ==="
          echo "Commit: ${{ github.sha }}"
          echo "Versi√≥n: $APP_VERSION"
          
          # Crear el despliegue en Render
          DEPLOY_RESPONSE=$(curl -sS -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"commit\":\"${{ github.sha }}\"}" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -o deploy_response.json)
          
          HTTP_CODE="${DEPLOY_RESPONSE: -3}"
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Respuesta de Render:"
          cat deploy_response.json
          
          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            DEPLOY_ID=$(jq -r '.id // empty' deploy_response.json)
            echo "‚úÖ Despliegue iniciado correctamente"
            echo "Deploy ID: $DEPLOY_ID"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Error al iniciar despliegue"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Wait for deployment completion
        if: steps.deploy.outputs.success == 'true'
        id: wait_deploy
        run: |
          echo "=== ESPERANDO COMPLETION DEL DESPLIEGUE ==="
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"
          MAX_WAIT=600  # 10 minutos m√°ximo
          WAIT_TIME=0
          
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            DEPLOY_STATUS=$(curl -sS \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID" | \
              jq -r '.status // "unknown"')
            
            echo "Estado actual: $DEPLOY_STATUS (esperado: $WAIT_TIME s)"
            
            if [ "$DEPLOY_STATUS" = "succeeded" ]; then
              echo "‚úÖ Despliegue completado exitosamente"
              echo "deploy_final_status=succeeded" >> $GITHUB_OUTPUT
              break
            elif [ "$DEPLOY_STATUS" = "failed" ] || [ "$DEPLOY_STATUS" = "canceled" ]; then
              echo "‚ùå Despliegue fall√≥ con estado: $DEPLOY_STATUS"
              echo "deploy_final_status=failed" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$DEPLOY_STATUS" = "unknown" ]; then
              echo "‚ö†Ô∏è  Estado desconocido, reintentando..."
            fi
            
            sleep 30
            WAIT_TIME=$((WAIT_TIME + 30))
          done
          
          if [ $WAIT_TIME -ge $MAX_WAIT ]; then
            echo "‚ùå Timeout esperando el despliegue"
            echo "deploy_final_status=timeout" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify deployment
        if: steps.wait_deploy.outputs.deploy_final_status == 'succeeded'
        run: |
          echo "=== VERIFICANDO DESPLIEGUE ==="
          # Aqu√≠ puedes agregar verificaciones adicionales como health checks
          echo "‚úÖ Despliegue verificado exitosamente"
          echo "üéâ Aplicaci√≥n desplegada con versi√≥n: $APP_VERSION"
          echo "Dashboard: https://dashboard.render.com/web/$RENDER_SERVICE_ID"

  rollback:
    needs: build-and-deploy
    if: failure() && needs.build-and-deploy.outputs.deploy_success == 'true'
    uses: ./.github/workflows/rollback.yml
    with:
      reason: 'Rollback autom√°tico tras fallo en despliegue de CD'
    secrets: inherit

  notify:
    needs: [build-and-deploy, rollback]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify deployment result
        run: |
          echo "=== RESUMEN DEL DESPLIEGUE ==="
          
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "‚úÖ DESPLIEGUE EXITOSO"
            echo "Versi√≥n desplegada: ${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)"
          else
            echo "‚ùå DESPLIEGUE FALLIDO"
            
            if [ "${{ needs.rollback.result }}" = "success" ]; then
              echo "‚úÖ Rollback ejecutado exitosamente"
            elif [ "${{ needs.rollback.result }}" = "failure" ]; then
              echo "‚ùå Rollback tambi√©n fall√≥"
            elif [ "${{ needs.rollback.result }}" = "skipped" ]; then
              echo "‚ö†Ô∏è  Rollback no fue necesario"
            fi
          fi
          
          echo ""
          echo "Detalles:"
          echo "- Commit: ${{ github.sha }}"
          echo "- Build: ${{ github.run_number }}"
          echo "- Workflow: ${{ github.run_id }}"
